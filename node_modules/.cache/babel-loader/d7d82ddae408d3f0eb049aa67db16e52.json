{"ast":null,"code":"class Messenger {\n  /**\n   * @callback onMessage\n   * @param {error} err\n   * @param {Object} result\n   */\n\n  /**\n   * @description Callback function to send response to the window source of the message\n   * @callback sendResponse\n   * @param {Object} response Message response\n   * @returns {void}\n   */\n\n  /**\n   * @description Callback function to manage message received from the channel\n      * @callback onMessageCallback\n      * @param {Object} json\n   * @param {Window} source\n      * @param {sendResponse} cb\n   * @param {Messenger} bridge\n   * @returns {void}\n      */\n\n  /**\n   * @description Send message options\n   * @typedef {Object} sendMessageOptions\n   * @property {boolean} waitForReply Wait for a reply from the recipient\n   * @property {string} origin Override Window.origin\n   * @property {number} timeout Timeout to wait for reply message, default 4000 msec\n   */\n\n  /**\n      * @param {string} channelName  Channel Name\n      * @param {onMessageCallback} [onMessageCallback] Callback function\n      */\n  constructor(channelName, onMessageCallback) {\n    this.channelName = channelName;\n    this.onMessage = onMessageCallback;\n\n    this._installListener();\n    /**\n     * @access private\n     * @typedef {Object.<string, onMessage>} RequestObject Request objects\n     * @type {RequestObject} _requests Mapping of request ids to callbacks\n     */\n\n\n    this._requests = new Map();\n    /**\n     * @access private\n     * @type {number} Next request id\n     */\n\n    this._nextId = 0;\n    /**\n     * @access private\n     * @type {number} Time to wait for the message response\n     */\n\n    this._defaultTimeout = 4000;\n  }\n  /**\n   * @access private\n   */\n\n\n  _installListener() {\n    const that = this;\n    /**\n     * @access private\n     * @param {Window} this\n     * @param {MessageEvent} event\n     */\n\n    this._listener = function (event) {\n      // Ignore invalid messages or those after the client has closed\n      if (!event.data || typeof event.data !== 'string') {\n        return;\n      }\n\n      let json;\n\n      try {\n        json = JSON.parse(event.data);\n\n        if (!json.channel || json.channel !== that.channelName) {\n          return;\n        }\n\n        if (typeof json.message !== 'object') {\n          return;\n        }\n      } catch (err) {\n        // Ignore malformed messages or not targetting us\n        return;\n      } // Add request callback\n\n\n      if (typeof json.replyId !== 'undefined') {\n        if (typeof json.replyId !== 'number' || json.replyId % 1 !== 0) {\n          return;\n        } // If we have a message waiting for a reply, process it, else ignore\n\n\n        const req = that._requests.get(json.replyId);\n\n        if (req) {\n          // Ignore if the message comes from somewhere else\n          if (event.origin !== req.targetOrigin) {\n            return;\n          }\n\n          clearTimeout(req.timeout);\n\n          that._requests.delete(json.replyId);\n\n          req.resolve(json.message);\n        }\n      } else {\n        if (typeof json.id !== 'number' || json.id % 1 !== 0 || !that.onMessage) {\n          return;\n        } // We received a message\n\n\n        const channel = that.channelName;\n        const replyId = json.id;\n        const origin = event.origin;\n\n        const replyMessage = function (message) {\n          const request = {\n            channel,\n            replyId,\n            message: message\n          };\n          event.source.postMessage(JSON.stringify(request), origin);\n        };\n\n        that.onMessage(json.message, event.origin, event.source, replyMessage, that);\n      }\n    };\n\n    window.addEventListener(\"message\", this._listener);\n  }\n  /**\n   * @access public\n   * @description Send a message to another window\n   * @param {Window} targetWindow Target Window\n   * @param {Object} message Object Message\n   * @param {string} origin Target origin\n   * @param {sendMessageOptions} [options] Object Message\n   * @returns {Promise<any>} Returns\n   */\n\n\n  sendMessage(targetWindow, message, origin, options) {\n    let targetOrigin;\n\n    try {\n      targetOrigin = new URL(origin).origin;\n    } catch (e) {\n      throw new Error('Invalid origin URL');\n    } // Prepare message\n\n\n    const request = {\n      channel: this.channelName,\n      id: this.getNextId(),\n      message: message\n    };\n\n    if (options && options.waitForReply) {\n      const that = this;\n      return new Promise(function (resolve, reject) {\n        // Set a timeout if a response is not received\n        const timeout = setTimeout(function () {\n          const req = that._requests.get(request.id);\n\n          if (req) {\n            that._requests.delete(request.id);\n\n            reject(new Error('Timeout expired for the message response'));\n          }\n        }, options && options.timeout ? options.timeout : that._defaultTimeout);\n\n        that._requests.set(request.id, {\n          timeout,\n          resolve,\n          targetOrigin\n        });\n\n        targetWindow.postMessage(JSON.stringify(request), targetOrigin);\n      });\n    }\n\n    targetWindow.postMessage(JSON.stringify(request), targetOrigin);\n  }\n  /**\n   * @access public\n   * @description Close client connection\n   */\n\n\n  close() {\n    window.removeEventListener('message', this._listener);\n    this._listener = null;\n    delete this._requests;\n  }\n  /**\n   * @access private\n   */\n\n\n  getNextId() {\n    this._nextId += 1;\n    return this._nextId;\n  }\n\n}\n\nmodule.exports = Messenger;","map":{"version":3,"names":["Messenger","constructor","channelName","onMessageCallback","onMessage","_installListener","_requests","Map","_nextId","_defaultTimeout","that","_listener","event","data","json","JSON","parse","channel","message","err","replyId","req","get","origin","targetOrigin","clearTimeout","timeout","delete","resolve","id","replyMessage","request","source","postMessage","stringify","window","addEventListener","sendMessage","targetWindow","options","URL","e","Error","getNextId","waitForReply","Promise","reject","setTimeout","set","close","removeEventListener","module","exports"],"sources":["/Users/iaonniskokkoros/Documents/OG BrokeBoiz/node_modules/@randlabs/communication-bridge/lib/messenger.js"],"sourcesContent":["class Messenger {\n\n\t/**\n\t * @callback onMessage\n\t * @param {error} err\n\t * @param {Object} result\n\t */\n\n\t/**\n\t * @description Callback function to send response to the window source of the message\n\t * @callback sendResponse\n\t * @param {Object} response Message response\n\t * @returns {void}\n\t */\n\n\t/**\n\t * @description Callback function to manage message received from the channel\n     * @callback onMessageCallback\n     * @param {Object} json\n\t * @param {Window} source\n     * @param {sendResponse} cb\n\t * @param {Messenger} bridge\n\t * @returns {void}\n     */\n\n\t/**\n\t * @description Send message options\n\t * @typedef {Object} sendMessageOptions\n\t * @property {boolean} waitForReply Wait for a reply from the recipient\n\t * @property {string} origin Override Window.origin\n\t * @property {number} timeout Timeout to wait for reply message, default 4000 msec\n\t */\n\n\t/**\n     * @param {string} channelName  Channel Name\n     * @param {onMessageCallback} [onMessageCallback] Callback function\n     */\n\n\tconstructor(channelName, onMessageCallback) {\n\t\tthis.channelName = channelName;\n\t\tthis.onMessage = onMessageCallback;\n\n\t\tthis._installListener();\n\n\t\t/**\n\t\t * @access private\n\t\t * @typedef {Object.<string, onMessage>} RequestObject Request objects\n\t\t * @type {RequestObject} _requests Mapping of request ids to callbacks\n\t\t */\n\t\tthis._requests = new Map();\n\n\t\t/**\n\t\t * @access private\n\t\t * @type {number} Next request id\n\t\t */\n\t\tthis._nextId = 0;\n\n\t\t/**\n\t\t * @access private\n\t\t * @type {number} Time to wait for the message response\n\t\t */\n\t\tthis._defaultTimeout = 4000;\n\t}\n\n\t/**\n\t * @access private\n\t */\n\n\t_installListener() {\n\t\tconst that = this;\n\n\t\t/**\n\t\t * @access private\n\t\t * @param {Window} this\n\t\t * @param {MessageEvent} event\n\t\t */\n\n\t\tthis._listener = function (event) {\n\t\t\t// Ignore invalid messages or those after the client has closed\n\t\t\tif (!event.data || typeof event.data !== 'string') {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet json;\n\n\t\t\ttry {\n\t\t\t\tjson = JSON.parse(event.data);\n\t\t\t\tif (!json.channel || json.channel !== that.channelName) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tif (typeof json.message !== 'object') {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tcatch (err) {\n\t\t\t\t // Ignore malformed messages or not targetting us\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Add request callback\n\t\t\tif (typeof json.replyId !== 'undefined') {\n\n\t\t\t\tif (typeof json.replyId !== 'number' || (json.replyId % 1) !== 0) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// If we have a message waiting for a reply, process it, else ignore\n\t\t\t\tconst req = that._requests.get(json.replyId);\n\t\t\t\tif (req) {\n\t\t\t\t\t// Ignore if the message comes from somewhere else\n\t\t\t\t\tif (event.origin !== req.targetOrigin) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tclearTimeout(req.timeout);\n\n\t\t\t\t\tthat._requests.delete(json.replyId);\n\n\t\t\t\t\treq.resolve(json.message);\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\tif (typeof json.id !== 'number' || (json.id % 1) !== 0 || !that.onMessage) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// We received a message\n\t\t\t\tconst channel = that.channelName;\n\t\t\t\tconst replyId = json.id;\n\t\t\t\tconst origin = event.origin;\n\n\t\t\t\tconst replyMessage = function (message) {\n\t\t\t\t\tconst request = {\n\t\t\t\t\t\tchannel,\n\t\t\t\t\t\treplyId,\n\t\t\t\t\t\tmessage: message,\n\t\t\t\t\t};\n\n\t\t\t\t\tevent.source.postMessage(\n\t\t\t\t\t\tJSON.stringify(request),\n\t\t\t\t\t\torigin\n\t\t\t\t\t);\n\t\t\t\t};\n\n\t\t\t\tthat.onMessage(json.message, event.origin, event.source, replyMessage, that);\n\t\t\t}\n\t\t};\n\n\t\twindow.addEventListener(\"message\", this._listener);\n\t}\n\n\t/**\n\t * @access public\n\t * @description Send a message to another window\n\t * @param {Window} targetWindow Target Window\n\t * @param {Object} message Object Message\n\t * @param {string} origin Target origin\n\t * @param {sendMessageOptions} [options] Object Message\n\t * @returns {Promise<any>} Returns\n\t */\n\tsendMessage(targetWindow, message, origin, options) {\n\t\tlet targetOrigin;\n\t\ttry {\n\t\t\ttargetOrigin = new URL(origin).origin;\n\t\t}\n\t\tcatch (e) {\n\t\t\tthrow new Error('Invalid origin URL');\n\t\t}\n\n\t\t// Prepare message\n\t\tconst request = {\n\t\t\tchannel: this.channelName,\n\t\t\tid: this.getNextId(),\n\t\t\tmessage: message,\n\t\t};\n\n\t\tif (options && options.waitForReply) {\n\t\t\tconst that = this;\n\n\t\t\treturn new Promise(function (resolve, reject) {\n\t\t\t\t// Set a timeout if a response is not received\n\t\t\t\tconst timeout = setTimeout(function() {\n\t\t\t\t\tconst req = that._requests.get(request.id);\n\t\t\t\t\tif (req) {\n\t\t\t\t\t\tthat._requests.delete(request.id);\n\n\t\t\t\t\t\treject(new Error('Timeout expired for the message response'));\n\t\t\t\t\t}\n\t\t\t\t}, options && options.timeout ? options.timeout : that._defaultTimeout);\n\n\t\t\t\tthat._requests.set(request.id, {\n\t\t\t\t\ttimeout,\n\t\t\t\t\tresolve,\n\t\t\t\t\ttargetOrigin,\n\t\t\t\t});\n\n\t\t\t\ttargetWindow.postMessage(\n\t\t\t\t\tJSON.stringify(request),\n\t\t\t\t\ttargetOrigin\n\t\t\t\t);\n\t\t\t});\n\n\t\t}\n\t\ttargetWindow.postMessage(\n\t\t\tJSON.stringify(request),\n\t\t\ttargetOrigin\n\t\t);\n\t}\n\n\t/**\n\t * @access public\n\t * @description Close client connection\n\t */\n\n\tclose() {\n\t\twindow.removeEventListener('message', this._listener);\n\t\tthis._listener = null;\n\t\tdelete this._requests;\n\t}\n\n\t/**\n\t * @access private\n\t */\n\n\tgetNextId() {\n\t\tthis._nextId += 1;\n\t\treturn this._nextId;\n\t}\n}\n\nmodule.exports = Messenger;\n"],"mappings":"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"},"metadata":{},"sourceType":"script"}