{"ast":null,"code":"import { isBrowser, getLocation, getQueryString, detectEnv, appendToQueryString } from \"@walletconnect/utils\";\nimport NetworkMonitor from \"./network\";\nconst WS = typeof global.WebSocket !== \"undefined\" ? global.WebSocket : require(\"ws\");\n\nclass SocketTransport {\n  constructor(opts) {\n    this.opts = opts;\n    this._queue = [];\n    this._events = [];\n    this._subscriptions = [];\n    this._protocol = opts.protocol;\n    this._version = opts.version;\n    this._url = \"\";\n    this._netMonitor = null;\n    this._socket = null;\n    this._nextSocket = null;\n    this._subscriptions = opts.subscriptions || [];\n    this._netMonitor = opts.netMonitor || new NetworkMonitor();\n\n    if (!opts.url || typeof opts.url !== \"string\") {\n      throw new Error(\"Missing or invalid WebSocket url\");\n    }\n\n    this._url = opts.url;\n\n    this._netMonitor.on(\"online\", () => this._socketCreate());\n  }\n\n  set readyState(value) {}\n\n  get readyState() {\n    return this._socket ? this._socket.readyState : -1;\n  }\n\n  set connecting(value) {}\n\n  get connecting() {\n    return this.readyState === 0;\n  }\n\n  set connected(value) {}\n\n  get connected() {\n    return this.readyState === 1;\n  }\n\n  set closing(value) {}\n\n  get closing() {\n    return this.readyState === 2;\n  }\n\n  set closed(value) {}\n\n  get closed() {\n    return this.readyState === 3;\n  }\n\n  open() {\n    this._socketCreate();\n  }\n\n  close() {\n    this._socketClose();\n  }\n\n  send(message, topic, silent) {\n    if (!topic || typeof topic !== \"string\") {\n      throw new Error(\"Missing or invalid topic field\");\n    }\n\n    this._socketSend({\n      topic: topic,\n      type: \"pub\",\n      payload: message,\n      silent: !!silent\n    });\n  }\n\n  subscribe(topic) {\n    this._socketSend({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    });\n  }\n\n  on(event, callback) {\n    this._events.push({\n      event,\n      callback\n    });\n  }\n\n  _socketCreate() {\n    if (this._nextSocket) {\n      return;\n    }\n\n    const url = getWebSocketUrl(this._url, this._protocol, this._version);\n    this._nextSocket = new WS(url);\n\n    if (!this._nextSocket) {\n      throw new Error(\"Failed to create socket\");\n    }\n\n    this._nextSocket.onmessage = event => this._socketReceive(event);\n\n    this._nextSocket.onopen = () => this._socketOpen();\n\n    this._nextSocket.onerror = event => this._socketError(event);\n\n    this._nextSocket.onclose = () => {\n      setTimeout(() => {\n        this._nextSocket = null;\n\n        this._socketCreate();\n      }, 1000);\n    };\n  }\n\n  _socketOpen() {\n    this._socketClose();\n\n    this._socket = this._nextSocket;\n    this._nextSocket = null;\n\n    this._queueSubscriptions();\n\n    this._pushQueue();\n  }\n\n  _socketClose() {\n    if (this._socket) {\n      this._socket.onclose = () => {};\n\n      this._socket.close();\n    }\n  }\n\n  _socketSend(socketMessage) {\n    const message = JSON.stringify(socketMessage);\n\n    if (this._socket && this._socket.readyState === 1) {\n      this._socket.send(message);\n    } else {\n      this._setToQueue(socketMessage);\n\n      this._socketCreate();\n    }\n  }\n\n  async _socketReceive(event) {\n    let socketMessage;\n\n    try {\n      socketMessage = JSON.parse(event.data);\n    } catch (error) {\n      return;\n    }\n\n    this._socketSend({\n      topic: socketMessage.topic,\n      type: \"ack\",\n      payload: \"\",\n      silent: true\n    });\n\n    if (this._socket && this._socket.readyState === 1) {\n      const events = this._events.filter(event => event.event === \"message\");\n\n      if (events && events.length) {\n        events.forEach(event => event.callback(socketMessage));\n      }\n    }\n  }\n\n  _socketError(e) {\n    const events = this._events.filter(event => event.event === \"error\");\n\n    if (events && events.length) {\n      events.forEach(event => event.callback(e));\n    }\n  }\n\n  _queueSubscriptions() {\n    const subscriptions = this._subscriptions;\n    subscriptions.forEach(topic => this._queue.push({\n      topic: topic,\n      type: \"sub\",\n      payload: \"\",\n      silent: true\n    }));\n    this._subscriptions = this.opts.subscriptions || [];\n  }\n\n  _setToQueue(socketMessage) {\n    this._queue.push(socketMessage);\n  }\n\n  _pushQueue() {\n    const queue = this._queue;\n    queue.forEach(socketMessage => this._socketSend(socketMessage));\n    this._queue = [];\n  }\n\n}\n\nfunction getWebSocketUrl(_url, protocol, version) {\n  var _a, _b;\n\n  const url = _url.startsWith(\"https\") ? _url.replace(\"https\", \"wss\") : _url.startsWith(\"http\") ? _url.replace(\"http\", \"ws\") : _url;\n  const splitUrl = url.split(\"?\");\n  const params = isBrowser() ? {\n    protocol,\n    version,\n    env: \"browser\",\n    host: ((_a = getLocation()) === null || _a === void 0 ? void 0 : _a.host) || \"\"\n  } : {\n    protocol,\n    version,\n    env: ((_b = detectEnv()) === null || _b === void 0 ? void 0 : _b.name) || \"\"\n  };\n  const queryString = appendToQueryString(getQueryString(splitUrl[1] || \"\"), params);\n  return splitUrl[0] + \"?\" + queryString;\n}\n\nexport default SocketTransport;","map":{"version":3,"mappings":"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","names":["isBrowser","getLocation","getQueryString","detectEnv","appendToQueryString","NetworkMonitor","WS","global","WebSocket","require","SocketTransport","constructor","opts","_protocol","protocol","_version","version","_url","_netMonitor","_socket","_nextSocket","_subscriptions","subscriptions","netMonitor","url","Error","on","_socketCreate","readyState","value","connecting","connected","closing","closed","open","close","_socketClose","send","message","topic","silent","_socketSend","type","payload","subscribe","event","callback","_events","push","getWebSocketUrl","onmessage","_socketReceive","onopen","_socketOpen","onerror","_socketError","onclose","setTimeout","_queueSubscriptions","_pushQueue","socketMessage","JSON","stringify","_setToQueue","parse","data","error","events","filter","length","forEach","e","_queue","queue","startsWith","replace","splitUrl","split","params","env","host","_a","_b","name","queryString"],"sourceRoot":"","sources":["../../src/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}